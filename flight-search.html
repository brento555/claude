<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –∞–≤–∏–∞–±–∏–ª–µ—Ç–æ–≤ - –í—Å–µ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .search-panel {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .trip-type {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-group input[type="radio"] {
            width: auto;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .aggregators-status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }

        .aggregators-status.active {
            display: block;
        }

        .status-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .aggregators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .aggregator-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 13px;
        }

        .aggregator-item .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .aggregator-item.searching .status-icon {
            background: #ffa726;
            animation: pulse 1.5s infinite;
        }

        .aggregator-item.completed .status-icon {
            background: #66bb6a;
        }

        .aggregator-item.failed .status-icon {
            background: #ef5350;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .results-count {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }

        .filters-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            margin: 0;
        }

        .filter-group select {
            padding: 8px 12px;
            font-size: 13px;
        }

        .flights-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .flight-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .flight-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .flight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .airline {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #333;
        }

        .airline-logo {
            width: 40px;
            height: 40px;
            background: #f0f0f0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .source-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .flight-route {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-point {
            text-align: left;
        }

        .route-point.destination {
            text-align: right;
        }

        .time {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .city {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .route-middle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .duration {
            font-size: 13px;
            color: #666;
        }

        .route-line {
            width: 100px;
            height: 2px;
            background: #e0e0e0;
            position: relative;
        }

        .route-line::after {
            content: '‚úà';
            position: absolute;
            right: -5px;
            top: -8px;
            color: #667eea;
        }

        .flight-info {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .flight-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .price {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }

        .currency {
            font-size: 18px;
            color: #666;
        }

        .book-btn {
            background: #4caf50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .book-btn:hover {
            background: #45a049;
        }

        .no-results {
            background: white;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            color: #666;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .flight-route {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .route-point.destination {
                text-align: left;
            }

            .route-middle {
                flex-direction: row;
                justify-content: space-between;
            }

            .route-line {
                width: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ´ –ü–æ–∏—Å–∫ –∞–≤–∏–∞–±–∏–ª–µ—Ç–æ–≤</h1>
            <p class="subtitle">–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞–º –∏ –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</p>
        </header>

        <div class="search-panel">
            <form id="searchForm">
                <div class="trip-type">
                    <div class="radio-group">
                        <input type="radio" id="roundtrip" name="tripType" value="roundtrip" checked>
                        <label for="roundtrip">–¢—É–¥–∞ –∏ –æ–±—Ä–∞—Ç–Ω–æ</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" id="oneway" name="tripType" value="oneway">
                        <label for="oneway">–í –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É</label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="origin">–û—Ç–∫—É–¥–∞</label>
                        <input type="text" id="origin" placeholder="–ú–æ—Å–∫–≤–∞" value="–ú–æ—Å–∫–≤–∞" required>
                    </div>
                    <div class="form-group">
                        <label for="destination">–ö—É–¥–∞</label>
                        <input type="text" id="destination" placeholder="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥" value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="departDate">–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞</label>
                        <input type="date" id="departDate" required>
                    </div>
                    <div class="form-group" id="returnDateGroup">
                        <label for="returnDate">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                        <input type="date" id="returnDate">
                    </div>
                    <div class="form-group">
                        <label for="passengers">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</label>
                        <select id="passengers">
                            <option value="1">1 –ø–∞—Å—Å–∞–∂–∏—Ä</option>
                            <option value="2">2 –ø–∞—Å—Å–∞–∂–∏—Ä–∞</option>
                            <option value="3">3 –ø–∞—Å—Å–∞–∂–∏—Ä–∞</option>
                            <option value="4">4 –ø–∞—Å—Å–∞–∂–∏—Ä–∞</option>
                            <option value="5">5 –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</option>
                            <option value="6">6 –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="class">–ö–ª–∞—Å—Å</label>
                        <select id="class">
                            <option value="economy">–≠–∫–æ–Ω–æ–º</option>
                            <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                            <option value="first">–ü–µ—Ä–≤—ã–π</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="search-btn" id="searchBtn">
                    –ù–∞–π—Ç–∏ –±–∏–ª–µ—Ç—ã
                </button>
            </form>
        </div>

        <div class="aggregators-status" id="aggregatorsStatus">
            <div class="status-title">–ü–æ–∏—Å–∫ –±–∏–ª–µ—Ç–æ–≤...</div>
            <div class="aggregators-grid" id="aggregatorsGrid"></div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-count" id="resultsCount">–ù–∞–π–¥–µ–Ω–æ —Ä–µ–π—Å–æ–≤: 0</div>
                <div class="filters-bar">
                    <div class="filter-group">
                        <label for="sortBy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                        <select id="sortBy">
                            <option value="price">–ü–æ —Ü–µ–Ω–µ</option>
                            <option value="duration">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–ª–µ—Ç–∞</option>
                            <option value="departure">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ª–µ—Ç–∞</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterAirline">–ê–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—è:</label>
                        <select id="filterAirline">
                            <option value="all">–í—Å–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterSource">–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
                        <select id="filterSource">
                            <option value="all">–í—Å–µ</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flights-list" id="flightsList"></div>
        </div>
    </div>

    <script>
        // Aggregators and airlines data
        const aggregators = [
            'Aviasales', 'Skyscanner', 'Kayak', 'Google Flights',
            'Momondo', 'Kiwi.com', 'Ozon Travel', 'Tutu.ru',
            'OneTwoTrip', 'Biletix', 'S7 Airlines', 'Aeroflot'
        ];

        // Airport codes mapping (Russian cities)
        const airportCodes = {
            '–ú–æ—Å–∫–≤–∞': 'MOW',
            '–º–æ—Å–∫–≤–∞': 'MOW',
            'Moscow': 'MOW',
            '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': 'LED',
            '—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥': 'LED',
            'Saint Petersburg': 'LED',
            '–ü–µ—Ç–µ—Ä–±—É—Ä–≥': 'LED',
            '–°–ü–±': 'LED',
            '–ö–∞–∑–∞–Ω—å': 'KZN',
            '–∫–∞–∑–∞–Ω—å': 'KZN',
            '–°–æ—á–∏': 'AER',
            '—Å–æ—á–∏': 'AER',
            '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': 'SVX',
            '–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': 'SVX',
            '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': 'OVB',
            '–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': 'OVB',
            '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫': 'VVO',
            '–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫': 'VVO',
            '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': 'KGD',
            '–∫–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥': 'KGD',
            '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä': 'KRR',
            '–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä': 'KRR',
            '–°–∞–º–∞—Ä–∞': 'KUF',
            '—Å–∞–º–∞—Ä–∞': 'KUF',
            '–£—Ñ–∞': 'UFA',
            '—É—Ñ–∞': 'UFA',
            '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫': 'KJA',
            '–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫': 'KJA',
            '–ò—Ä–∫—É—Ç—Å–∫': 'IKT',
            '–∏—Ä–∫—É—Ç—Å–∫': 'IKT',
            '–•–∞–±–∞—Ä–æ–≤—Å–∫': 'KHV',
            '—Ö–∞–±–∞—Ä–æ–≤—Å–∫': 'KHV',
            '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥': 'GOJ',
            '–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥': 'GOJ',
            '–ß–µ–ª—è–±–∏–Ω—Å–∫': 'CEK',
            '—á–µ–ª—è–±–∏–Ω—Å–∫': 'CEK'
        };

        // URLs for aggregators
        const aggregatorURLs = {
            'Aviasales': 'https://www.aviasales.ru/search',
            'Skyscanner': 'https://www.skyscanner.ru/transport/flights',
            'Kayak': 'https://www.kayak.ru/flights',
            'Google Flights': 'https://www.google.com/travel/flights',
            'Momondo': 'https://www.momondo.ru/flight-search',
            'Kiwi.com': 'https://www.kiwi.com/ru/search',
            'Ozon Travel': 'https://www.ozon.ru/travel/flights',
            'Tutu.ru': 'https://www.tutu.ru/flights',
            'OneTwoTrip': 'https://www.onetwotrip.com/ru/flights',
            'Biletix': 'https://biletix.ru/flights',
            'S7 Airlines': 'https://www.s7.ru/book',
            'Aeroflot': 'https://www.aeroflot.ru/ru-ru/booking/flights'
        };

        const airlines = [
            { name: 'Aeroflot', code: 'SU', logo: '‚úàÔ∏è', url: 'https://www.aeroflot.ru/ru-ru/booking/flights' },
            { name: 'S7 Airlines', code: 'S7', logo: 'üõ©Ô∏è', url: 'https://www.s7.ru/book' },
            { name: 'Pobeda', code: 'DP', logo: '‚úàÔ∏è', url: 'https://www.pobeda.aero/booking' },
            { name: 'Ural Airlines', code: 'U6', logo: 'üõ´', url: 'https://www.uralairlines.ru/booking' },
            { name: 'Utair', code: 'UT', logo: '‚úàÔ∏è', url: 'https://www.utair.ru/booking' },
            { name: 'Rossiya Airlines', code: 'FV', logo: 'üõ¨', url: 'https://www.rossiya-airlines.com/booking' },
            { name: 'Nordwind', code: 'N4', logo: '‚úàÔ∏è', url: 'https://www.nordwindairlines.ru/booking' },
            { name: 'Red Wings', code: 'WZ', logo: 'üõ©Ô∏è', url: 'https://www.flyredwings.com/booking' }
        ];

        let allFlights = [];
        let displayedFlights = [];

        // Set default dates
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const weekLater = new Date();
        weekLater.setDate(weekLater.getDate() + 8);

        document.getElementById('departDate').valueAsDate = tomorrow;
        document.getElementById('returnDate').valueAsDate = weekLater;

        // Trip type toggle
        document.querySelectorAll('input[name="tripType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const returnDateGroup = document.getElementById('returnDateGroup');
                if (e.target.value === 'oneway') {
                    returnDateGroup.style.display = 'none';
                } else {
                    returnDateGroup.style.display = 'flex';
                }
            });
        });

        // Search form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await performSearch();
        });

        async function performSearch() {
            const searchBtn = document.getElementById('searchBtn');
            const aggregatorsStatus = document.getElementById('aggregatorsStatus');
            const resultsSection = document.getElementById('resultsSection');

            // Reset
            allFlights = [];
            searchBtn.disabled = true;
            searchBtn.textContent = '–ü–æ–∏—Å–∫...';
            aggregatorsStatus.classList.add('active');
            resultsSection.classList.remove('active');

            // Show aggregators status
            const aggregatorsGrid = document.getElementById('aggregatorsGrid');
            aggregatorsGrid.innerHTML = aggregators.map(agg => `
                <div class="aggregator-item searching" data-aggregator="${agg}">
                    <div class="status-icon">‚è≥</div>
                    <span>${agg}</span>
                </div>
            `).join('');

            // Simulate searching each aggregator
            for (let i = 0; i < aggregators.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));

                const aggregatorElement = document.querySelector(`[data-aggregator="${aggregators[i]}"]`);
                const success = Math.random() > 0.1; // 90% success rate

                if (success) {
                    aggregatorElement.classList.remove('searching');
                    aggregatorElement.classList.add('completed');
                    aggregatorElement.querySelector('.status-icon').textContent = '‚úì';

                    // Generate flights for this aggregator
                    const flights = generateFlights(aggregators[i], 2 + Math.floor(Math.random() * 3));
                    allFlights.push(...flights);
                } else {
                    aggregatorElement.classList.remove('searching');
                    aggregatorElement.classList.add('failed');
                    aggregatorElement.querySelector('.status-icon').textContent = '‚úó';
                }
            }

            // Show results
            setTimeout(() => {
                searchBtn.disabled = false;
                searchBtn.textContent = '–ù–∞–π—Ç–∏ –±–∏–ª–µ—Ç—ã';
                resultsSection.classList.add('active');
                populateFilters();
                displayFlights();
            }, 500);
        }

        function generateFlights(source, count) {
            const flights = [];
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            const departDate = document.getElementById('departDate').value;
            const returnDate = document.getElementById('returnDate').value;
            const passengers = document.getElementById('passengers').value;
            const travelClass = document.getElementById('class').value;
            const tripType = document.querySelector('input[name="tripType"]:checked').value;

            for (let i = 0; i < count; i++) {
                const airline = airlines[Math.floor(Math.random() * airlines.length)];
                const basePrice = 3000 + Math.random() * 15000;
                const departHour = 6 + Math.floor(Math.random() * 16);
                const departMinute = Math.floor(Math.random() * 60);
                const durationMinutes = 90 + Math.floor(Math.random() * 240);
                const stops = Math.random() > 0.7 ? 1 : 0;

                const arriveTime = new Date();
                arriveTime.setHours(departHour);
                arriveTime.setMinutes(departMinute + durationMinutes);

                flights.push({
                    source,
                    airline: airline.name,
                    airlineCode: airline.code,
                    airlineLogo: airline.logo,
                    airlineURL: airline.url,
                    flightNumber: airline.code + (1000 + Math.floor(Math.random() * 9000)),
                    origin,
                    destination,
                    departDate,
                    returnDate,
                    passengers,
                    travelClass,
                    tripType,
                    departTime: `${String(departHour).padStart(2, '0')}:${String(departMinute).padStart(2, '0')}`,
                    arriveTime: `${String(arriveTime.getHours()).padStart(2, '0')}:${String(arriveTime.getMinutes()).padStart(2, '0')}`,
                    duration: `${Math.floor(durationMinutes / 60)}—á ${durationMinutes % 60}–º`,
                    durationMinutes,
                    stops,
                    price: Math.round(basePrice / 100) * 100
                });
            }

            return flights;
        }

        function populateFilters() {
            // Populate airline filter
            const airlines = [...new Set(allFlights.map(f => f.airline))].sort();
            const airlineFilter = document.getElementById('filterAirline');
            airlineFilter.innerHTML = '<option value="all">–í—Å–µ</option>' +
                airlines.map(a => `<option value="${a}">${a}</option>`).join('');

            // Populate source filter
            const sources = [...new Set(allFlights.map(f => f.source))].sort();
            const sourceFilter = document.getElementById('filterSource');
            sourceFilter.innerHTML = '<option value="all">–í—Å–µ</option>' +
                sources.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function displayFlights() {
            let flights = [...allFlights];

            // Apply filters
            const airlineFilter = document.getElementById('filterAirline').value;
            const sourceFilter = document.getElementById('filterSource').value;

            if (airlineFilter !== 'all') {
                flights = flights.filter(f => f.airline === airlineFilter);
            }

            if (sourceFilter !== 'all') {
                flights = flights.filter(f => f.source === sourceFilter);
            }

            // Apply sorting
            const sortBy = document.getElementById('sortBy').value;

            switch(sortBy) {
                case 'price':
                    flights.sort((a, b) => a.price - b.price);
                    break;
                case 'duration':
                    flights.sort((a, b) => a.durationMinutes - b.durationMinutes);
                    break;
                case 'departure':
                    flights.sort((a, b) => a.departTime.localeCompare(b.departTime));
                    break;
            }

            displayedFlights = flights;

            // Update count
            document.getElementById('resultsCount').textContent = `–ù–∞–π–¥–µ–Ω–æ —Ä–µ–π—Å–æ–≤: ${flights.length}`;

            // Display flights
            const flightsList = document.getElementById('flightsList');

            if (flights.length === 0) {
                flightsList.innerHTML = '<div class="no-results">–ë–∏–ª–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.</div>';
                return;
            }

            flightsList.innerHTML = flights.map(flight => `
                <div class="flight-card">
                    <div class="flight-header">
                        <div class="airline">
                            <div class="airline-logo">${flight.airlineLogo}</div>
                            <div>
                                <div>${flight.airline}</div>
                                <div style="font-size: 12px; color: #999; font-weight: normal;">${flight.flightNumber}</div>
                            </div>
                        </div>
                        <div class="source-badge">${flight.source}</div>
                    </div>

                    <div class="flight-route">
                        <div class="route-point">
                            <div class="time">${flight.departTime}</div>
                            <div class="city">${flight.origin}</div>
                        </div>

                        <div class="route-middle">
                            <div class="duration">${flight.duration}</div>
                            <div class="route-line"></div>
                        </div>

                        <div class="route-point destination">
                            <div class="time">${flight.arriveTime}</div>
                            <div class="city">${flight.destination}</div>
                        </div>
                    </div>

                    <div class="flight-info">
                        <div class="info-item">
                            <span>üé´</span>
                            <span>${flight.stops === 0 ? '–ü—Ä—è–º–æ–π' : '1 –ø–µ—Ä–µ—Å–∞–¥–∫–∞'}</span>
                        </div>
                        <div class="info-item">
                            <span>üí∫</span>
                            <span>${document.getElementById('class').selectedOptions[0].text}</span>
                        </div>
                        <div class="info-item">
                            <span>üë•</span>
                            <span>${document.getElementById('passengers').value} –ø–∞—Å—Å.</span>
                        </div>
                    </div>

                    <div class="flight-footer">
                        <div>
                            <span class="price">${flight.price.toLocaleString()}</span>
                            <span class="currency">‚ÇΩ</span>
                        </div>
                        <button class="book-btn" onclick="bookFlight(${displayedFlights.indexOf(flight)})">
                            –ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function bookFlight(flightIndex) {
            const flight = displayedFlights[flightIndex];
            if (!flight) return;

            // Get airport codes
            const originCode = airportCodes[flight.origin] || 'MOW';
            const destCode = airportCodes[flight.destination] || 'LED';

            // Format dates for URL (DDMM format)
            const formatDateShort = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                return day + month;
            };

            const departDateShort = formatDateShort(flight.departDate);
            const returnDateShort = flight.tripType === 'roundtrip' && flight.returnDate
                ? formatDateShort(flight.returnDate)
                : '';

            // Build URL based on aggregator
            let bookingURL;

            switch(flight.source) {
                case 'Aviasales':
                    // Format: /search/MOW0506LED1206 (origin+departdate+dest+returndate)
                    const aviasalesPath = flight.tripType === 'roundtrip' && returnDateShort
                        ? `${originCode}${departDateShort}${destCode}${returnDateShort}`
                        : `${originCode}${departDateShort}${destCode}`;
                    bookingURL = `https://www.aviasales.ru/search/${aviasalesPath}?passengers=${flight.passengers}&class=${flight.travelClass}`;
                    break;

                case 'Skyscanner':
                    bookingURL = `https://www.skyscanner.ru/transport/flights/${originCode}/${destCode}/${flight.departDate}/${flight.returnDate || ''}?adults=${flight.passengers}&cabinclass=${flight.travelClass}`;
                    break;

                case 'Google Flights':
                    bookingURL = `https://www.google.com/travel/flights?q=flights+from+${originCode}+to+${destCode}+on+${flight.departDate}`;
                    break;

                case 'Kiwi.com':
                    bookingURL = `https://www.kiwi.com/ru/search/results/${originCode}/${destCode}/${flight.departDate}/${flight.returnDate || ''}?adults=${flight.passengers}`;
                    break;

                case 'S7 Airlines':
                    bookingURL = `https://www.s7.ru/book.html?origin=${originCode}&destination=${destCode}&date=${flight.departDate}&passengers=${flight.passengers}`;
                    break;

                case 'Aeroflot':
                    bookingURL = `https://www.aeroflot.ru/ru-ru/booking/flights?from=${originCode}&to=${destCode}&date=${flight.departDate}&adults=${flight.passengers}`;
                    break;

                default:
                    // Default to aggregator URL or airline URL
                    bookingURL = aggregatorURLs[flight.source] || flight.airlineURL;
                    break;
            }

            // Log booking details
            console.log('Opening booking page:', {
                source: flight.source,
                flight: flight.flightNumber,
                url: bookingURL,
                codes: { origin: originCode, destination: destCode },
                details: {
                    from: flight.origin,
                    to: flight.destination,
                    date: flight.departDate,
                    passengers: flight.passengers,
                    class: flight.travelClass
                }
            });

            // Show informative message before redirect
            const message = `
üé´ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ ${flight.source}

–î–µ—Ç–∞–ª–∏ –ø–æ–∏—Å–∫–∞:
‚úàÔ∏è –†–µ–π—Å: ${flight.flightNumber}
üìç –û—Ç–∫—É–¥–∞: ${flight.origin} (${originCode})
üìç –ö—É–¥–∞: ${flight.destination} (${destCode})
üìÖ –î–∞—Ç–∞: ${flight.departDate}
${flight.tripType === 'roundtrip' && flight.returnDate ? 'üîÑ –û–±—Ä–∞—Ç–Ω–æ: ' + flight.returnDate : ''}
üë• –ü–∞—Å—Å–∞–∂–∏—Ä—ã: ${flight.passengers}
üí∫ –ö–ª–∞—Å—Å: ${flight.travelClass}

–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–∞–π—Ç ${flight.source} –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
            `.trim();

            if (confirm(message + '\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                window.open(bookingURL, '_blank');
            }
        }

        // Filter and sort listeners
        document.getElementById('sortBy').addEventListener('change', displayFlights);
        document.getElementById('filterAirline').addEventListener('change', displayFlights);
        document.getElementById('filterSource').addEventListener('change', displayFlights);
    </script>
</body>
</html>
